<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SubsetJuliaVM Web Test Runner</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1e1f1c;
            color: #f8f8f2;
            padding: 2rem;
        }

        h1 {
            margin-bottom: 1rem;
        }

        .controls {
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        button.primary {
            background: #66d9ef;
            color: #1e1f1c;
        }

        button.primary:hover {
            background: #52b5d6;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .summary {
            padding: 1rem;
            background: #272822;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-family: monospace;
        }

        .summary .pass { color: #a6e22e; }
        .summary .fail { color: #f92672; }
        .summary .skip { color: #75715e; }

        .results {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .test-item {
            padding: 1rem;
            background: #272822;
            border-radius: 8px;
            border-left: 4px solid #75715e;
        }

        .test-item.pass {
            border-left-color: #a6e22e;
        }

        .test-item.fail {
            border-left-color: #f92672;
        }

        .test-item.running {
            border-left-color: #66d9ef;
        }

        .test-item .name {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .test-item .status {
            font-size: 0.875rem;
        }

        .test-item .status.pass { color: #a6e22e; }
        .test-item .status.fail { color: #f92672; }
        .test-item .status.running { color: #66d9ef; }

        .test-item .error {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: rgba(249, 38, 114, 0.1);
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.8rem;
            color: #f92672;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .test-item .output {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #1e1f1c;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
        }

        .progress {
            height: 4px;
            background: #3e3d32;
            border-radius: 2px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: #66d9ef;
            transition: width 0.3s;
        }

        /* Debug Parse Section */
        .debug-section {
            margin-bottom: 2rem;
            padding: 1rem;
            background: #272822;
            border-radius: 8px;
        }

        .debug-section h2 {
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .debug-input {
            width: 100%;
            min-height: 100px;
            padding: 0.75rem;
            background: #1e1f1c;
            border: 1px solid #3e3d32;
            border-radius: 4px;
            color: #f8f8f2;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 0.5rem;
        }

        .debug-input:focus {
            outline: none;
            border-color: #66d9ef;
        }

        .debug-output {
            max-height: 400px;
            overflow: auto;
            padding: 0.75rem;
            background: #1e1f1c;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre;
            margin-top: 0.5rem;
        }

        .debug-output.error {
            color: #f92672;
        }

        .debug-output .key {
            color: #66d9ef;
        }

        .debug-output .string {
            color: #e6db74;
        }

        .debug-output .number {
            color: #ae81ff;
        }

        .debug-output .boolean {
            color: #f92672;
        }

        .debug-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .debug-tab {
            padding: 0.25rem 0.75rem;
            background: #3e3d32;
            border: none;
            border-radius: 4px;
            color: #f8f8f2;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .debug-tab.active {
            background: #66d9ef;
            color: #1e1f1c;
        }

        .debug-tab:hover:not(.active) {
            background: #4e4d42;
        }
    </style>
</head>
<body>
    <h1>SubsetJuliaVM Web Test Runner</h1>

    <!-- Debug Parse Section -->
    <div class="debug-section">
        <h2>Debug Parse</h2>
        <textarea id="debug-input" class="debug-input" placeholder="Enter Julia code to parse...">1 + 2 * 3</textarea>
        <div class="controls">
            <button id="debug-parse-btn" class="primary">Parse</button>
            <div class="debug-tabs">
                <button class="debug-tab active" data-view="tree">Tree</button>
                <button class="debug-tab" data-view="json">JSON</button>
                <button class="debug-tab" data-view="sexp">S-expr</button>
            </div>
        </div>
        <div id="debug-output" class="debug-output"></div>
    </div>

    <hr style="border-color: #3e3d32; margin: 2rem 0;">

    <h2>Test Runner</h2>

    <div class="controls">
        <button id="run-all" class="primary">Run All Tests</button>
        <button id="run-failed">Re-run Failed</button>
        <span id="status"></span>
    </div>

    <div class="progress">
        <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
    </div>

    <div class="summary" id="summary">
        Click "Run All Tests" to start testing all samples.
    </div>

    <div class="results" id="results"></div>

    <script type="module">
        import { samplesIR } from './samples_ir.js?v=23';

        let wasm = null;
        let parser = null;
        let testResults = [];

        // Initialize
        async function init() {
            document.getElementById('status').textContent = 'Loading...';

            try {
                // Load WASM
                const module = await import('./pkg/subset_julia_vm_web.js');
                await module.default();
                wasm = module;
                console.log('WASM loaded');

                // Load parser
                const { Parser: TSParser, Language } = await import('https://cdn.jsdelivr.net/npm/web-tree-sitter@0.25.3/tree-sitter.js');
                await TSParser.init();
                parser = new TSParser();
                const Julia = await Language.load('./tree-sitter-julia.wasm');
                parser.setLanguage(Julia);
                console.log('Parser loaded');

                document.getElementById('status').textContent = 'Ready';
                document.getElementById('run-all').disabled = false;

                // Show sample list
                showSampleList();
            } catch (e) {
                document.getElementById('status').textContent = 'Error: ' + e.message;
                console.error(e);
            }
        }

        function showSampleList() {
            const results = document.getElementById('results');
            results.innerHTML = samplesIR.map((sample, idx) => `
                <div class="test-item" id="test-${idx}">
                    <div class="name">${idx + 1}. ${sample.name}</div>
                    <div class="status">Pending</div>
                </div>
            `).join('');
        }

        // Serialize CST
        function serializeNode(node, source) {
            const text = source.substring(node.startIndex, node.endIndex);
            const result = {
                type: node.type,
                start: node.startIndex,
                end: node.endIndex,
                start_line: node.startPosition.row + 1,
                end_line: node.endPosition.row + 1,
                start_column: node.startPosition.column + 1,
                end_column: node.endPosition.column + 1,
                is_named: node.isNamed,
                text: text,
                children: []
            };

            for (let i = 0; i < node.childCount; i++) {
                const child = node.child(i);
                if (child) {
                    result.children.push(serializeNode(child, source));
                }
            }

            return result;
        }

        // Run single test
        async function runTest(sample, idx) {
            const testItem = document.getElementById(`test-${idx}`);
            const statusEl = testItem.querySelector('.status');

            testItem.className = 'test-item running';
            statusEl.className = 'status running';
            statusEl.textContent = 'Running...';

            // Remove old error/output
            const oldError = testItem.querySelector('.error');
            const oldOutput = testItem.querySelector('.output');
            if (oldError) oldError.remove();
            if (oldOutput) oldOutput.remove();

            try {
                const code = sample.code;
                const seed = 42;
                let result;

                if (sample.ir) {
                    // Use pre-compiled IR
                    result = wasm.run_ir_json(sample.ir, BigInt(seed));
                } else {
                    // Parse and run
                    const tree = parser.parse(code);

                    // Check for parse errors
                    if (tree.rootNode.hasError) {
                        throw new Error('Parse error in source code');
                    }

                    const cstJson = JSON.stringify(serializeNode(tree.rootNode, code));
                    result = wasm.run_from_cst_json(cstJson, code, BigInt(seed));
                }

                if (result.success) {
                    testItem.className = 'test-item pass';
                    statusEl.className = 'status pass';
                    statusEl.textContent = 'PASS';

                    if (result.output) {
                        const outputEl = document.createElement('div');
                        outputEl.className = 'output';
                        outputEl.textContent = result.output;
                        testItem.appendChild(outputEl);
                    }

                    return { pass: true };
                } else {
                    throw new Error(result.error_message || 'Execution failed');
                }
            } catch (e) {
                testItem.className = 'test-item fail';
                statusEl.className = 'status fail';
                statusEl.textContent = 'FAIL';

                const errorEl = document.createElement('div');
                errorEl.className = 'error';
                errorEl.textContent = e.message;
                testItem.appendChild(errorEl);

                return { pass: false, error: e.message };
            }
        }

        // Run all tests
        async function runAllTests(onlyFailed = false) {
            const runAllBtn = document.getElementById('run-all');
            const runFailedBtn = document.getElementById('run-failed');
            const statusEl = document.getElementById('status');
            const progressBar = document.getElementById('progress-bar');

            runAllBtn.disabled = true;
            runFailedBtn.disabled = true;

            testResults = [];
            let passed = 0;
            let failed = 0;
            let skipped = 0;

            const samplesToRun = onlyFailed
                ? samplesIR.map((s, i) => ({ sample: s, idx: i }))
                    .filter((_, i) => testResults[i] && !testResults[i].pass)
                : samplesIR.map((s, i) => ({ sample: s, idx: i }));

            for (let i = 0; i < samplesToRun.length; i++) {
                const { sample, idx } = samplesToRun[i];
                statusEl.textContent = `Running ${i + 1}/${samplesToRun.length}: ${sample.name}`;
                progressBar.style.width = `${((i + 1) / samplesToRun.length) * 100}%`;

                const result = await runTest(sample, idx);
                testResults[idx] = result;

                if (result.pass) {
                    passed++;
                } else {
                    failed++;
                }

                // Small delay to allow UI update
                await new Promise(r => setTimeout(r, 10));
            }

            // Update summary
            const summary = document.getElementById('summary');
            summary.innerHTML = `
                <span class="pass">PASS: ${passed}</span> |
                <span class="fail">FAIL: ${failed}</span> |
                Total: ${samplesToRun.length}
            `;

            statusEl.textContent = 'Done';
            runAllBtn.disabled = false;
            runFailedBtn.disabled = failed === 0;
        }

        // Event listeners
        document.getElementById('run-all').addEventListener('click', () => runAllTests(false));
        document.getElementById('run-failed').addEventListener('click', () => runAllTests(true));

        // Debug Parse functionality
        let currentView = 'tree';
        let lastParsedCst = null;

        function setupDebugParse() {
            const debugInput = document.getElementById('debug-input');
            const debugOutput = document.getElementById('debug-output');
            const parseBtn = document.getElementById('debug-parse-btn');
            const tabs = document.querySelectorAll('.debug-tab');

            parseBtn.addEventListener('click', () => {
                debugParse(debugInput.value);
            });

            // Ctrl/Cmd+Enter to parse
            debugInput.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    debugParse(debugInput.value);
                }
            });

            // Tab switching
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentView = tab.dataset.view;
                    if (lastParsedCst) {
                        renderCst(lastParsedCst, debugInput.value);
                    }
                });
            });
        }

        function debugParse(code) {
            const debugOutput = document.getElementById('debug-output');

            if (!parser) {
                debugOutput.className = 'debug-output error';
                debugOutput.textContent = 'Parser not loaded yet. Please wait...';
                return;
            }

            try {
                const tree = parser.parse(code);
                lastParsedCst = tree.rootNode;
                renderCst(tree.rootNode, code);
            } catch (e) {
                debugOutput.className = 'debug-output error';
                debugOutput.textContent = 'Parse error: ' + e.message;
            }
        }

        function renderCst(rootNode, source) {
            const debugOutput = document.getElementById('debug-output');
            debugOutput.className = 'debug-output';

            switch (currentView) {
                case 'tree':
                    debugOutput.innerHTML = renderTree(rootNode, source, 0);
                    break;
                case 'json':
                    const cst = serializeNode(rootNode, source);
                    debugOutput.innerHTML = syntaxHighlightJson(JSON.stringify(cst, null, 2));
                    break;
                case 'sexp':
                    debugOutput.textContent = rootNode.toString();
                    break;
            }
        }

        function renderTree(node, source, depth) {
            const indent = '  '.repeat(depth);
            const text = source.substring(node.startIndex, node.endIndex);
            const shortText = text.length > 40 ? text.substring(0, 40) + '...' : text;
            const escapedText = shortText.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '\\n');

            let html = `${indent}<span class="key">${node.type}</span>`;
            if (node.childCount === 0) {
                html += ` <span class="string">"${escapedText}"</span>`;
            }
            html += ` <span class="number">[${node.startIndex}:${node.endIndex}]</span>`;
            if (node.hasError) {
                html += ` <span class="boolean">ERROR</span>`;
            }
            html += '\n';

            for (let i = 0; i < node.childCount; i++) {
                const child = node.child(i);
                if (child) {
                    html += renderTree(child, source, depth + 1);
                }
            }

            return html;
        }

        function syntaxHighlightJson(json) {
            return json
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                    let cls = 'number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'key';
                            match = match.slice(0, -1); // Remove trailing colon for styling
                            return '<span class="' + cls + '">' + match + '</span>:';
                        } else {
                            cls = 'string';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'boolean';
                    } else if (/null/.test(match)) {
                        cls = 'boolean';
                    }
                    return '<span class="' + cls + '">' + match + '</span>';
                });
        }

        // Start
        init().then(() => {
            setupDebugParse();
            // Parse initial code after parser is loaded
            setTimeout(() => {
                debugParse(document.getElementById('debug-input').value);
            }, 100);
        });
    </script>
</body>
</html>
